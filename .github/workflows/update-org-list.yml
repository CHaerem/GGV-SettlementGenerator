name: Update Organization List

on:
  issues:
    types: [opened]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'new-organization') || contains(github.event.issue.labels.*.name, 'remove-organization')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update organizations.json
        id: update
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # Read current list
          ORGS=$(cat organizations.json | jq -r '.organizations')
          CHANGES_MADE=false
          ERROR_MSG=""

          if [[ "${{ contains(github.event.issue.labels.*.name, 'new-organization') }}" == "true" ]]; then
            # Extract org names from issue body (lines starting with "- ")
            NEW_ORGS=$(echo "$ISSUE_BODY" | grep -E "^- " | sed 's/^- //' | head -20)

            if [ -z "$NEW_ORGS" ]; then
              ERROR_MSG="Ingen organisasjoner funnet i issue body"
            else
              # Add each org to the list
              while IFS= read -r org; do
                if [ -n "$org" ]; then
                  # Check if already exists
                  EXISTS=$(echo "$ORGS" | jq --arg org "$org" 'map(select(. == $org)) | length')
                  if [ "$EXISTS" -eq "0" ]; then
                    ORGS=$(echo "$ORGS" | jq --arg org "$org" '. + [$org] | unique | sort')
                    echo "Adding: $org"
                    CHANGES_MADE=true
                  else
                    echo "Already exists: $org"
                  fi
                fi
              done <<< "$NEW_ORGS"

              if [ "$CHANGES_MADE" = false ]; then
                ERROR_MSG="Alle organisasjonene finnes allerede i listen"
              fi
            fi

            ACTION="add"

          elif [[ "${{ contains(github.event.issue.labels.*.name, 'remove-organization') }}" == "true" ]]; then
            # Extract org name from title (format: "Fjern organisasjon: OrgName")
            ORG_NAME=$(echo "$ISSUE_TITLE" | sed 's/Fjern organisasjon: //')

            # Check if org exists in list
            EXISTS=$(echo "$ORGS" | jq --arg org "$ORG_NAME" 'map(select(. == $org)) | length')

            if [ "$EXISTS" -eq "0" ]; then
              ERROR_MSG="Organisasjonen '$ORG_NAME' finnes ikke i listen"
            else
              ORGS=$(echo "$ORGS" | jq --arg org "$ORG_NAME" 'map(select(. != $org))')
              echo "Removing: $ORG_NAME"
              CHANGES_MADE=true
            fi

            ACTION="remove"
          fi

          # Check if we should proceed
          if [ -n "$ERROR_MSG" ]; then
            echo "error=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "should_close=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Write updated list
          echo "{\"organizations\": $ORGS}" | jq '.' > organizations.json

          # Count orgs
          COUNT=$(echo "$ORGS" | jq 'length')
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "should_close=false" >> $GITHUB_OUTPUT

      - name: Close issue if validation failed
        if: steps.update.outputs.should_close == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ Kunne ikke opprette PR: ${{ steps.update.outputs.error }}\n\nDette issue lukkes automatisk.`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Create Pull Request
        if: steps.update.outputs.should_close != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update organizations.json from issue #${{ github.event.issue.number }}"
          title: "Update org list: ${{ github.event.issue.title }}"
          body: |
            Automatisk PR basert på issue #${{ github.event.issue.number }}

            **Handling:** ${{ steps.update.outputs.action }}
            **Antall organisasjoner etter endring:** ${{ steps.update.outputs.count }}

            Merge denne PR-en for å godkjenne endringen.
            Lukk PR-en for å avslå.

            ---
            Closes #${{ github.event.issue.number }}
          branch: org-update-${{ github.event.issue.number }}
          labels: automated-pr
